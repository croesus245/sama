<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>Enhanced Realtor Dashboard - MWG Hostels</title>
    <link rel="icon" type="image/png" href="MWG logo@300x.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="theme-system.css">
    <link rel="stylesheet" href="theme-integration.css">
    <link rel="stylesheet" href="universal-bg-system.css">
    <link rel="stylesheet" href="perfect-vibe-theme.css">
    <link rel="stylesheet" href="glass-morphism-global.css">
    <link rel="stylesheet" href="realtor-style.css">
    <link rel="stylesheet" href="advanced-styles.css">
    <link rel="stylesheet" href="dashboard-modals.css">
    <!-- API Connector -->
    <script src="hostel-api.js"></script>
    <!-- Cloudinary Upload Widget -->
    <script src="https://widget.cloudinary.com/v2.0/global/all.js" type="text/javascript"></script>
    <style>
        .dashboard-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
            background: #f8fafc;
            min-height: 100vh;
        }
        
        .dashboard-header {
            background: linear-gradient(135deg, #1e40af, #3b82f6);
            color: white;
            padding: 2rem;
            border-radius: 16px;
            margin-bottom: 2rem;
            box-shadow: 0 10px 30px rgba(30, 64, 175, 0.2);
        }
        
        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        
        .hostel-management {
            background: white;
            border-radius: 16px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        .hostel-card {
            display: flex;
            align-items: center;
            padding: 1.5rem;
            border-bottom: 1px solid #e5e7eb;
            transition: background-color 0.3s ease;
        }
        
        .hostel-card:hover {
            background-color: #f9fafb;
        }
        
        .hostel-image {
            width: 120px;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
            margin-right: 1.5rem;
        }
        
        .hostel-info {
            flex: 1;
        }
        
        .hostel-name {
            font-size: 1.125rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 0.5rem;
        }
        
        .hostel-details {
            color: #6b7280;
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
        }
        
        .availability-toggle {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
            margin-left: 1rem;
        }
        
        .availability-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #dc2626;
            transition: .4s;
            border-radius: 34px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: #16a34a;
        }
        
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .status-available {
            background-color: #dcfce7;
            color: #166534;
        }
        
        .status-unavailable {
            background-color: #fee2e2;
            color: #991b1b;
        }
        
        .applications-count {
            background: #eff6ff;
            color: #1d4ed8;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-weight: 600;
            margin-left: 1rem;
        }
        
        .action-buttons {
            display: flex;
            gap: 0.5rem;
            margin-left: 1rem;
        }
        
        .btn-secondary {
            background: #6b7280;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            transition: background-color 0.3s ease;
        }
        
        .btn-secondary:hover {
            background: #4b5563;
        }
        
        .search-filter {
            padding: 1.5rem;
            background: #f8fafc;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .search-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 1rem;
        }
        
        .filter-tabs {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .filter-tab {
            padding: 0.5rem 1rem;
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .filter-tab.active {
            background: #1e40af;
            color: white;
            border-color: #1e40af;
        }
        
        .bulk-actions {
            padding: 1rem 1.5rem;
            background: #f3f4f6;
            border-bottom: 1px solid #e5e7eb;
            display: none;
        }
        
        .bulk-actions.show {
            display: block;
        }
        
        @media (max-width: 768px) {
            .dashboard-container {
                padding: 1rem;
            }
            
            .hostel-card {
                flex-direction: column;
                text-align: center;
            }
            
            .hostel-image {
                margin: 0 0 1rem 0;
            }
            
            .action-buttons {
                margin: 1rem 0 0 0;
            }
        }
    </style>
    <script src="asset-path-fix.js" defer></script>
</head>
<body>
    <!-- Dynamic Background System -->
    <div class="dynamic-background"></div>
    <div class="geometric-overlay"></div>
    <div class="floating-elements">
        <div class="floating-book"></div>
        <div class="floating-graduation"></div>
        <div class="floating-building"></div>
    </div>
    <div class="particles">
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
    </div>
    
    <div class="dashboard-container">
        <!-- Pending Approval Banner -->
        <div id="pendingBanner">
            <div class="pending-banner-content">
                <div class="pending-banner-left">
                    <i class="fas fa-hourglass-half pending-banner-icon"></i>
                    <div>
                        <div class="pending-banner-title">‚è≥ Account Pending Approval</div>
                        <div class="pending-banner-description">Your account is awaiting admin verification. You can add hostels, but they won't be visible to students until approved.</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Dashboard Header -->
        <div class="dashboard-header">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold mb-2">Enhanced Realtor Dashboard</h1>
                    <p class="opacity-90">Manage your hostel listings and applications efficiently</p>
                </div>
                <div class="text-right">
                    <div class="text-lg font-semibold">Welcome back, <span id="realtorName">Realtor</span>!</div>
                    <div class="text-sm opacity-75" id="currentDate"></div>
                    <div class="pending-banner-actions">
                        <button onclick="showProfileModal()" class="btn-profile">
                            <i class="fas fa-user-circle mr-1"></i> Update Profile
                        </button>
                        <button onclick="handleLogout()" class="btn-logout">
                            <i class="fas fa-sign-out-alt mr-1"></i> Logout
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dashboard Stats -->
        <div class="dashboard-stats">
            <div class="stat-card">
                <div class="flex items-center">
                    <div class="bg-blue-100 p-3 rounded-full mr-4">
                        <i class="fas fa-home text-blue-600 text-xl"></i>
                    </div>
                    <div>
                        <div class="text-2xl font-bold text-gray-800" id="totalHostels">0</div>
                        <div class="text-gray-600">Total Hostels</div>
                    </div>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="flex items-center">
                    <div class="bg-green-100 p-3 rounded-full mr-4">
                        <i class="fas fa-check-circle text-green-600 text-xl"></i>
                    </div>
                    <div>
                        <div class="text-2xl font-bold text-gray-800" id="availableHostels">0</div>
                        <div class="text-gray-600">Available</div>
                    </div>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="flex items-center">
                    <div class="bg-red-100 p-3 rounded-full mr-4">
                        <i class="fas fa-times-circle text-red-600 text-xl"></i>
                    </div>
                    <div>
                        <div class="text-2xl font-bold text-gray-800" id="unavailableHostels">0</div>
                        <div class="text-gray-600">Unavailable</div>
                    </div>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="flex items-center">
                    <div class="bg-yellow-100 p-3 rounded-full mr-4">
                        <i class="fas fa-file-alt text-yellow-600 text-xl"></i>
                    </div>
                    <div>
                        <div class="text-2xl font-bold text-gray-800" id="totalApplications">0</div>
                        <div class="text-gray-600">Applications</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Hostel Management -->
        <div class="hostel-management">
            <div class="flex justify-between items-center mb-4">
                <div class="search-filter flex-1 mr-4">
                    <input type="text" id="hostelSearch" class="search-input" placeholder="Search hostels by name, location, or price...">
                    <div class="filter-tabs">
                        <div class="filter-tab active" data-filter="all">All Hostels</div>
                        <div class="filter-tab" data-filter="available">Available</div>
                        <div class="filter-tab" data-filter="unavailable">Unavailable</div>
                        <div class="filter-tab" data-filter="pending">Pending Applications</div>
                    </div>
                </div>
                <button class="btn-primary btn-add-hostel" onclick="showAddHostelModal()">
                    <i class="fas fa-plus"></i> Add New Hostel
                </button>
            </div>
            
            <div class="bulk-actions" id="bulkActions">
                <div class="flex items-center gap-4">
                    <span class="font-semibold">Bulk Actions:</span>
                    <button class="btn-secondary" onclick="bulkSetAvailable()">Set Available</button>
                    <button class="btn-secondary" onclick="bulkSetUnavailable()">Set Unavailable</button>
                    <button class="btn-secondary" onclick="clearBulkSelection()">Clear Selection</button>
                </div>
            </div>
            
            <div id="hostelList">
                <!-- Hostels will be populated by JavaScript -->
            </div>
        </div>
        
        <!-- Add Hostel Modal -->
        <div id="addHostelModal" class="modal-overlay">
            <div class="modal-container">
                <div class="modal-header">
                    <h2 class="modal-title">Add New Hostel</h2>
                    <button onclick="closeAddHostelModal()" class="modal-close">&times;</button>
                </div>
                
                <form id="addHostelForm" onsubmit="return handleAddHostel(event)">
                    <div class="form-group">
                        <label class="form-label">Hostel Name *</label>
                        <input type="text" id="hostelName" required class="form-input">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Location (Gate Area) *</label>
                        <select id="hostelLocation" required class="form-select">
                            <option value="">-- Select Gate Area --</option>
                            <option value="West Gate">West Gate</option>
                            <option value="South Gate">South Gate</option>
                            <option value="North Gate">North Gate</option>
                        </select>
                        <small class="form-hint">Choose the nearest gate to your hostel</small>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Detailed Description *</label>
                        <textarea id="hostelDescription" required placeholder="Describe your hostel: rooms available, amenities, nearby landmarks, transport access, etc." 
                            class="form-textarea"></textarea>
                        <small class="form-hint">Provide detailed information to help students make informed decisions (min 50 characters)</small>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Price (‚Ç¶/year) *</label>
                        <input type="number" id="hostelPrice" required placeholder="150000" min="0" step="1000" class="form-input">
                        <small class="form-hint">Annual rent in Naira</small>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Hostel Images (up to 5) *</label>
                        <button type="button" onclick="openHostelImagesWidget()" class="btn-upload btn-upload-images">
                            <i class="fas fa-images"></i> Upload Hostel Images (<span id="hostelImageCount">0</span>/5)
                        </button>
                        <div id="hostelImagesPreview" class="images-preview-grid"></div>
                        <input type="hidden" id="hostelImageUrls">
                        <small class="form-hint">Upload at least 1 image (up to 5 total) to showcase your hostel</small>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Hostel Video Tour (optional)</label>
                        <button type="button" onclick="openHostelVideoWidget()" class="btn-upload btn-upload-video">
                            <i class="fas fa-video"></i> <span id="hostelVideoStatus">Upload Video Tour</span>
                        </button>
                        <div id="hostelVideoPreview" class="video-preview-container">
                            <video id="hostelPreviewVideo" controls class="video-preview">
                                <source src="" type="video/mp4">
                            </video>
                            <button type="button" onclick="removeHostelVideo()" class="btn-remove-video">
                                <i class="fas fa-trash"></i> Remove Video
                            </button>
                        </div>
                        <input type="hidden" id="hostelVideoUrl">
                        <small class="form-hint">Max 2 minutes, 50MB. MP4, MOV, AVI, WebM supported</small>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Features (comma-separated)</label>
                        <input type="text" id="hostelFeatures" placeholder="WiFi, Security, Water Supply" class="form-input">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">WhatsApp Number *</label>
                        <input type="tel" id="hostelWhatsApp" required placeholder="2348145653433" pattern="[0-9]{13}" class="form-input">
                        <small class="form-hint">Format: 2348145653433 (country code + number, no spaces)</small>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label-inline">
                            <input type="checkbox" id="hostelAvailable" checked class="form-checkbox">
                            <span class="form-checkbox-label">Available for Booking</span>
                        </label>
                    </div>
                    
                    <div class="modal-actions">
                        <button type="submit" class="btn-submit">
                            <i class="fas fa-plus mr-1"></i> Add Hostel
                        </button>
                        <button type="button" onclick="closeAddHostelModal()" class="btn-cancel btn-cancel-full">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Edit Hostel Modal -->
        <div id="editHostelModal" class="modal-overlay">
            <div class="modal-container">
                <div class="modal-header">
                    <h2 class="modal-title">Edit Hostel</h2>
                    <button onclick="closeEditHostelModal()" class="modal-close">&times;</button>
                </div>
                
                <form id="editHostelForm" onsubmit="return handleEditHostel(event)">
                    <input type="hidden" id="editHostelId">
                    
                    <div class="form-group">
                        <label class="form-label">Hostel Name *</label>
                        <input type="text" id="editHostelName" required class="form-input">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Location *</label>
                        <input type="text" id="editHostelLocation" required class="form-input">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Price (‚Ç¶) *</label>
                        <input type="number" id="editHostelPrice" required min="0" class="form-input">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Hostel Images (up to 5)</label>
                        <button type="button" onclick="openEditHostelImagesWidget()" class="btn-upload btn-upload-images">
                            <i class="fas fa-images"></i> Upload Hostel Images (<span id="editHostelImageCount">0</span>/5)
                        </button>
                        <div id="editHostelImagesPreview" class="images-preview-grid"></div>
                        <input type="hidden" id="editHostelImageUrls">
                        <small class="form-hint">Upload up to 5 images to showcase your hostel</small>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Hostel Video Tour (optional)</label>
                        <button type="button" onclick="openEditHostelVideoWidget()" class="btn-upload btn-upload-video">
                            <i class="fas fa-video"></i> <span id="editHostelVideoStatus">Upload Video Tour</span>
                        </button>
                        <div id="editHostelVideoPreview" class="video-preview-container">
                            <video id="editHostelPreviewVideo" controls class="video-preview">
                                <source src="" type="video/mp4">
                            </video>
                            <button type="button" onclick="removeEditHostelVideo()" class="btn-remove-video">
                                <i class="fas fa-trash"></i> Remove Video
                            </button>
                        </div>
                        <input type="hidden" id="editHostelVideoUrl">
                        <small class="form-hint">Max 2 minutes, 50MB. MP4, MOV, AVI, WebM supported</small>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Features (comma-separated)</label>
                        <input type="text" id="editHostelFeatures" class="form-input">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">WhatsApp Number *</label>
                        <input type="tel" id="editHostelWhatsApp" required placeholder="2348145653433" pattern="[0-9]{13}" class="form-input">
                        <small class="form-hint">Format: 2348145653433 (country code + number, no spaces)</small>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label-inline">
                            <input type="checkbox" id="editHostelAvailable" class="form-checkbox">
                            <span class="form-checkbox-label">Available for Booking</span>
                        </label>
                    </div>
                    
                    <div class="modal-actions">
                        <button type="submit" class="btn-submit">
                            <i class="fas fa-save mr-1"></i> Save Changes
                        </button>
                        <button type="button" onclick="deleteHostel()" class="btn-delete">
                            <i class="fas fa-trash mr-1"></i> Delete
                        </button>
                        <button type="button" onclick="closeEditHostelModal()" class="btn-cancel">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Realtor Profile Modal -->
        <div id="profileModal" class="modal-overlay">
            <div class="modal-container modal-container-small">
                <div class="modal-header">
                    <h2 class="modal-title">
                        <i class="fas fa-user-circle mr-2"></i>Realtor Profile
                    </h2>
                    <button onclick="closeProfileModal()" class="modal-close">&times;</button>
                </div>
                
                <form id="profileForm" onsubmit="return handleProfileUpdate(event)">
                    <div class="form-group">
                        <label class="form-label">Your Name *</label>
                        <input type="text" id="profileName" required placeholder="Your full name" class="form-input">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Default WhatsApp Number *</label>
                        <input type="tel" id="profileWhatsApp" required placeholder="2348145653433" pattern="[0-9]{13}" class="form-input">
                        <small class="form-hint">This will be used as default for new hostels. Format: 2348145653433</small>
                    </div>
                    
                    <div style="background: #eff6ff; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border-left: 4px solid #1e40af;">
                        <p style="font-size: 0.875rem; color: #1e40af; margin: 0;">
                            <i class="fas fa-info-circle mr-1"></i>
                            <strong>How it works:</strong> Students will see a "Contact via WhatsApp" button on your hostel listings. When clicked, it opens WhatsApp with your number pre-filled.
                        </p>
                    </div>
                    
                    <div class="modal-actions">
                        <button type="submit" class="btn-submit">
                            <i class="fas fa-save mr-1"></i> Save Profile
                        </button>
                        <button type="button" onclick="closeProfileModal()" class="btn-cancel">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="advanced-features.js"></script>
    <script>
        // Mobile debugging helper
        const dashboardLog = (message, data = null) => {
            const timestamp = new Date().toLocaleTimeString();
            console.log(`üè¢ [DASHBOARD ${timestamp}] ${message}`, data || '');
        };

        // Utility functions
        const Utils = {
            // Format date as "Monday, Jan 15, 2025"
            formatDate: (date) => {
                const options = { weekday: 'long', year: 'numeric', month: 'short', day: 'numeric' };
                return date.toLocaleDateString('en-US', options);
            },
            
            // Format currency as "‚Ç¶150,000"
            formatCurrency: (amount) => {
                return new Intl.NumberFormat('en-NG', {
                    style: 'currency',
                    currency: 'NGN',
                    minimumFractionDigits: 0
                }).format(amount);
            },
            
            // Debounce function calls (e.g., for search input)
            debounce: (func, delay) => {
                let timeoutId;
                return function (...args) {
                    clearTimeout(timeoutId);
                    timeoutId = setTimeout(() => func.apply(this, args), delay);
                };
            }
        };

        dashboardLog('Dashboard page loaded');
        dashboardLog('Window width: ' + window.innerWidth + 'px');
        dashboardLog('User Agent: ' + navigator.userAgent);
        
        // Authentication Check - Redirect if not logged in
        let realtorData = null;
        let realtorToken = null;
        let authCheckComplete = false;
        
        function checkAuthentication() {
            dashboardLog('checkAuthentication() called');
            
            return new Promise((resolve, reject) => {
                try {
                    realtorToken = localStorage.getItem('realtorToken');
                    const storedData = localStorage.getItem('realtorData');
                    const validLogin = sessionStorage.getItem('validLogin');
                    
                    dashboardLog('Auth check - Token exists:', !!realtorToken);
                    dashboardLog('Auth check - Data exists:', !!storedData);
                    dashboardLog('Auth check - Valid login flag:', validLogin);
                    
                    // Check if we just came from login page
                    const referrer = document.referrer || '';
                    const cameFromLogin = referrer.includes('realtor-login.html');
                    
                    dashboardLog('Came from login page:', cameFromLogin);
                    
                    // If we have both token and data, authenticate immediately
                    if (realtorToken && storedData) {
                        try {
                            realtorData = JSON.parse(storedData);
                            
                            dashboardLog('Parsed realtor data keys:', Object.keys(realtorData));
                            
                            // Validate the parsed data has required fields
                            // Be flexible - accept id, _id, or realtorId
                            const realtorId = realtorData._id || realtorData.id || realtorData.realtorId;
                            
                            dashboardLog('Found realtor ID:', realtorId);
                            
                            if (!realtorData || !realtorId) {
                                console.error('Session data:', realtorData);
                                throw new Error('Realtor ID missing from session data. Found fields: ' + Object.keys(realtorData || {}).join(', '));
                            }
                            
                            // Store the ID in a consistent format for later use
                            if (!realtorData._id && realtorData.id) {
                                realtorData._id = realtorData.id;
                                dashboardLog('Normalized ID field to _id');
                            }

                            sessionStorage.setItem('validLogin', 'true');
                            authCheckComplete = true;
                            dashboardLog('‚úÖ Authentication successful!');
                            resolve(true);
                            return;
                        } catch (error) {
                            dashboardLog('‚ùå ERROR parsing realtor data:', error.message);
                            console.error('‚ùå Invalid realtor data:', error.message);
                            console.error('Raw stored data:', storedData);
                            localStorage.removeItem('realtorToken');
                            localStorage.removeItem('realtorData');
                            sessionStorage.removeItem('validLogin');
                            alert('‚ö†Ô∏è Session data corrupted: ' + error.message + '\n\nPlease login again.');
                            window.location.href = 'realtor-login.html';
                            reject(new Error('Corrupted data: ' + error.message));
                            return;
                        }
                    }
                    
                    // If no token/data AND we came from login, wait briefly for storage sync
                    if (cameFromLogin && validLogin === 'true') {
                        dashboardLog('‚è≥ Waiting for storage sync after login...');
                        
                        // Use requestAnimationFrame for better timing
                        requestAnimationFrame(() => {
                            requestAnimationFrame(() => {
                                // Check again after browser paint cycle
                                realtorToken = localStorage.getItem('realtorToken');
                                const retryStoredData = localStorage.getItem('realtorData');
                                
                                dashboardLog('After sync - Token:', !!realtorToken);
                                dashboardLog('After sync - Data:', !!retryStoredData);
                                
                                if (!realtorToken || !retryStoredData) {
                                    // Still no data - this is a storage issue
                                    dashboardLog('‚ùå ERROR: No data after storage sync');
                                    console.error('‚ùå No authentication data after storage sync');
                                    sessionStorage.removeItem('validLogin');
                                    alert('‚ö†Ô∏è Login session not saved.\n\nYour browser may be blocking storage.\n\nPlease:\n‚Ä¢ Disable Private/Incognito mode\n‚Ä¢ Enable cookies and site data\n‚Ä¢ Try a different browser (Chrome recommended)\n\nThen login again.');
                                    window.location.href = 'realtor-login.html';
                                    reject(new Error('Storage not persisting'));
                                } else {
                                    // Found data!
                                    dashboardLog('‚úÖ Storage sync successful!');
                                    try {
                                        realtorData = JSON.parse(retryStoredData);
                                        
                                        // Validate the parsed data - now backend returns both _id and id
                                        const realtorId = realtorData._id || realtorData.id || realtorData.realtorId;
                                        
                                        dashboardLog('Realtor ID after sync:', realtorId);
                                        
                                        if (!realtorData || !realtorId) {
                                            console.error('Session data:', realtorData);
                                            throw new Error('Realtor ID missing from session data. Found fields: ' + Object.keys(realtorData || {}).join(', '));
                                        }
                                        
                                        // Store the ID in consistent format
                                        if (!realtorData._id && realtorData.id) {
                                            realtorData._id = realtorData.id;
                                        }

                                        sessionStorage.setItem('validLogin', 'true');
                                        authCheckComplete = true;
                                        resolve(true);
                                    } catch (error) {
                                        console.error('‚ùå Invalid realtor data:', error.message);
                                        console.error('Raw stored data:', retryStoredData);
                                        localStorage.removeItem('realtorToken');
                                        localStorage.removeItem('realtorData');
                                        sessionStorage.removeItem('validLogin');
                                        alert('‚ö†Ô∏è Session data corrupted: ' + error.message + '\n\nPlease login again.');
                                        window.location.href = 'realtor-login.html';
                                        reject(new Error('Corrupted data: ' + error.message));
                                    }
                                }
                            });
                        });
                    } else {
                        // Not from login page, or no validLogin flag - immediate redirect
                        dashboardLog('‚ùå No authentication data - redirecting to login');
                        console.log('‚ùå No authentication data and not coming from login');
                        sessionStorage.removeItem('validLogin');
                        
                        // Silent redirect for better UX (no alert needed)
                        window.location.href = 'realtor-login.html';
                        reject(new Error('Not authenticated'));
                    }
                } catch (unexpectedError) {
                    console.error('‚ùå Unexpected error in checkAuthentication:', unexpectedError);
                    alert('Authentication system error: ' + unexpectedError.message + '\n\nPlease login again.');
                    localStorage.removeItem('realtorToken');
                    localStorage.removeItem('realtorData');
                    sessionStorage.removeItem('validLogin');
                    window.location.href = 'realtor-login.html';
                    reject(unexpectedError);
                }
            });
        }
        
        // API Configuration - Use logged-in realtor's ID (will be set after auth)
        let REALTOR_ID = null;
        let realtorProfile = null;
        
        // Hostels array (will be loaded from API)
        let hostels = [];
        
        // Load hostels from API
        async function loadHostelsFromAPI() {
            try {
                // Check if HostelAPI is available
                if (typeof HostelAPI === 'undefined') {
                    console.error('‚ùå HostelAPI not loaded');
                    throw new Error('HostelAPI module not available');
                }

const allHostels = await HostelAPI.getAllHostels();
// Filter to show only this realtor's hostels
                hostels = allHostels.filter(h => {
                    // Check both possible ID formats
                    const hostelRealtorId = h.realtorId || h.realtor?._id || h.realtor;
                    
                    // Convert both to strings for comparison
                    const hostelIdStr = String(hostelRealtorId || '');
                    const realtorIdStr = String(REALTOR_ID || '');
                    
                    // Debug: Log all comparisons
const matches = hostelIdStr === realtorIdStr;
                    
                    if (matches) {
}
                    
                    return matches;
                });
return hostels;
            } catch (error) {
                console.error('‚ùå Error loading hostels:', error);
                notifications.show('‚ö†Ô∏è Could not load hostels from server. Please check if the API is running.', 'error');
                return [];
            }
        }
        
        let currentFilter = 'all';
        let selectedHostels = new Set();
        let currentEditingHostelId = null;
        
        // Initialize dashboard
        async function initializeDashboard() {
            dashboardLog('initializeDashboard() called');
            
            try {
                dashboardLog('Step 1: Checking authentication...');
                
                // Wait for authentication to complete first
                await checkAuthentication();
                
                dashboardLog('Step 2: Authentication complete');
                
                // Check if authentication actually succeeded
                if (!realtorData) {
                    dashboardLog('‚ùå ERROR: No realtor data after auth check');
                    throw new Error('Authentication completed but no realtor data found');
                }
                
                dashboardLog('Step 3: Setting up realtor profile...');
                
                // Authentication successful - set up realtor data
                // Be flexible with ID field - accept id, _id, or realtorId
                REALTOR_ID = realtorData._id || realtorData.id || realtorData.realtorId;
                
                dashboardLog('Realtor ID:', REALTOR_ID);
                
                if (!REALTOR_ID) {
                    console.error('Available fields in realtorData:', Object.keys(realtorData));
                    dashboardLog('‚ùå ERROR: No realtor ID found');
                    throw new Error('Realtor ID not found in authenticated data. Available fields: ' + Object.keys(realtorData).join(', '));
                }
                
                realtorProfile = {
                    name: realtorData.fullName || 'Realtor',
                    whatsapp: realtorData.whatsapp || '2348145653433',
                    email: realtorData.email || '',
                    status: realtorData.status || 'pending'
                };
                
                dashboardLog('Realtor profile:', realtorProfile);
                dashboardLog('Step 4: Loading dashboard UI...');
                
                // Now load dashboard UI
                loadRealtorProfile();
                updateCurrentDate();
                showPendingBannerIfNeeded();
            
                // Show loading state
                const hostelListEl = document.getElementById('hostelList');
                if (hostelListEl) {
                    hostelListEl.innerHTML = '<div style="text-align: center; padding: 2rem;"><i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: #1e40af;"></i><p style="margin-top: 1rem;">Loading hostels...</p></div>';
                }
                
                dashboardLog('Step 5: Loading hostels from API...');
                
                // Load hostels from API
                await loadHostelsFromAPI();
                
                dashboardLog('Step 6: Updating UI...');
                
                // Update UI
                updateStats();
                renderHostels();
                setupEventListeners();
                
                dashboardLog('‚úÖ Dashboard initialization complete!');
                
            } catch (error) {
                dashboardLog('‚ùå FATAL ERROR during initialization:', error.message);
                console.error('‚ùå Dashboard initialization error:', error);
                console.error('Error details:', {
                    message: error.message,
                    stack: error.stack,
                    realtorData: realtorData,
                    realtorToken: realtorToken ? 'EXISTS' : 'MISSING'
                });
                
                // Check if this is just "Not authenticated" (user accessing dashboard without login)
                if (error.message === 'Not authenticated') {
                    // Silent redirect - no alert needed
                    dashboardLog('Not authenticated - silently redirecting to login');
                    localStorage.removeItem('realtorToken');
                    localStorage.removeItem('realtorData');
                    sessionStorage.removeItem('validLogin');
                    window.location.href = 'realtor-login.html';
                    return;
                }
                
                // For other errors, show detailed message
                const errorMsg = `Failed to initialize dashboard.\n\nError: ${error.message}\n\nThis usually means:\n‚Ä¢ Session data is corrupted\n‚Ä¢ Authentication timed out\n‚Ä¢ Browser storage was cleared\n\nPlease login again to create a fresh session.`;
                
                alert(errorMsg);
                
                // Clear corrupted data
                localStorage.removeItem('realtorToken');
                localStorage.removeItem('realtorData');
                sessionStorage.removeItem('validLogin');
                
                dashboardLog('Redirecting to login page...');
                
                // Redirect to login
                setTimeout(() => {
                    window.location.href = 'realtor-login.html';
                }, 1000);
            }
        }
        
        // Show pending approval banner if needed
        function showPendingBannerIfNeeded() {
            if (realtorProfile && realtorProfile.status === 'pending') {
                document.getElementById('pendingBanner').style.display = 'block';
            } else if (realtorProfile) {
                document.getElementById('pendingBanner').style.display = 'none';
            }
        }
        
        // Handle logout
        function handleLogout() {
            const confirmLogout = confirm('Are you sure you want to logout?');
            
            if (confirmLogout) {
                // Clear authentication data
                localStorage.removeItem('realtorToken');
                localStorage.removeItem('realtorData');
// Redirect to login page
                window.location.href = 'realtor-login-new.html';
            }
        }
        
        function updateCurrentDate() {
            const now = new Date();
            document.getElementById('currentDate').textContent = Utils.formatDate(now);
        }
        
        function updateStats() {
            const safeHostels = hostels || [];
            const totalHostels = safeHostels.length;
            const availableHostels = safeHostels.filter(h => h.available).length;
            const unavailableHostels = totalHostels - availableHostels;
            const totalApplications = safeHostels.reduce((sum, h) => sum + (h.applications || 0), 0);
            
            document.getElementById('totalHostels').textContent = totalHostels;
            document.getElementById('availableHostels').textContent = availableHostels;
            document.getElementById('unavailableHostels').textContent = unavailableHostels;
            document.getElementById('totalApplications').textContent = totalApplications;
        }
        
        function renderHostels(filteredHostels = null) {
            const hostelList = document.getElementById('hostelList');
            const hostelsToRender = filteredHostels || getFilteredHostels();
            
            if (hostelsToRender.length === 0) {
                hostelList.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-search text-4xl mb-4"></i>
                        <p>No hostels found matching your criteria</p>
                    </div>
                `;
                return;
            }
            
            hostelList.innerHTML = hostelsToRender.map(hostel => `
                <div class="hostel-card" data-hostel-id="${hostel._id || hostel.id}">
                    <input type="checkbox" class="hostel-checkbox mr-4" 
                           onchange="toggleHostelSelection('${hostel._id || hostel.id}')">
                    
                    <img src="${hostel.image}" alt="${hostel.name}" class="hostel-image" loading="lazy">
                    
                    <div class="hostel-info">
                        <div class="hostel-name">${hostel.name}</div>
                        <div class="hostel-details">
                            <i class="fas fa-map-marker-alt mr-1"></i> ${hostel.location}
                        </div>
                        <div class="hostel-details">
                            <i class="fas fa-naira-sign mr-1"></i> ${Utils.formatCurrency(hostel.price)}
                        </div>
                        <div class="hostel-details">
                            <i class="fas fa-star mr-1"></i> ${hostel.features.join(', ')}
                        </div>
                    </div>
                    
                    <div class="flex items-center">
                        <span class="status-badge ${hostel.available ? 'status-available' : 'status-unavailable'}">
                            ${hostel.available ? 'Available' : 'Unavailable'}
                        </span>
                        
                        <label class="availability-toggle">
                            <input type="checkbox" ${hostel.available ? 'checked' : ''} 
                                   onchange="toggleAvailability('${hostel._id || hostel.id}', this.checked)">
                            <span class="slider"></span>
                        </label>
                        
                        <div class="applications-count">
                            ${hostel.applications || 0} Applications
                        </div>
                        
                        <div class="action-buttons">
                            <button class="btn-secondary" onclick="viewApplications('${hostel._id || hostel.id}')">
                                <i class="fas fa-eye mr-1"></i> View
                            </button>
                            <button class="btn-secondary" onclick="editHostel('${hostel._id || hostel.id}')">
                                <i class="fas fa-edit mr-1"></i> Edit
                            </button>
                            <button class="btn-secondary" onclick="openDeleteModal('${hostel._id || hostel.id}')" style="background: #dc2626; color: white;">
                                <i class="fas fa-trash mr-1"></i> Delete
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        function getFilteredHostels() {
            const searchTerm = document.getElementById('hostelSearch').value.toLowerCase();
            
            let filtered = hostels.filter(hostel => {
                const matchesSearch = hostel.name.toLowerCase().includes(searchTerm) ||
                                    hostel.location.toLowerCase().includes(searchTerm) ||
                                    hostel.price.toString().includes(searchTerm);
                
                switch (currentFilter) {
                    case 'available':
                        return matchesSearch && hostel.available;
                    case 'unavailable':
                        return matchesSearch && !hostel.available;
                    case 'pending':
                        return matchesSearch && hostel.applications > 0;
                    default:
                        return matchesSearch;
                }
            });
            
            return filtered;
        }
        
        function toggleAvailability(hostelId, isAvailable) {
            const hostel = hostels.find(h => h.id === hostelId);
            if (hostel) {
                hostel.available = isAvailable;
                saveHostels(); // Save to localStorage
                updateStats();
                renderHostels();
                
                // Show notification
                const message = `${hostel.name} marked as ${isAvailable ? 'Available' : 'Unavailable'}`;
                notifications.show(message, isAvailable ? 'success' : 'warning');
                
                // Track the action
                Analytics.track('hostel_availability_changed', {
                    hostelId,
                    hostelName: hostel.name,
                    newStatus: isAvailable ? 'available' : 'unavailable'
                });
            }
        }
        
        function toggleHostelSelection(hostelId) {
            if (selectedHostels.has(hostelId)) {
                selectedHostels.delete(hostelId);
            } else {
                selectedHostels.add(hostelId);
            }
            
            const bulkActions = document.getElementById('bulkActions');
            if (selectedHostels.size > 0) {
                bulkActions.classList.add('show');
            } else {
                bulkActions.classList.remove('show');
            }
        }
        
        function bulkSetAvailable() {
            selectedHostels.forEach(hostelId => {
                const hostel = hostels.find(h => h.id === hostelId);
                if (hostel) {
                    hostel.available = true;
                }
            });
            
            saveHostels(); // Save to localStorage
            updateStats();
            renderHostels();
            clearBulkSelection();
            notifications.show(`${selectedHostels.size} hostels marked as available`, 'success');
        }
        
        function bulkSetUnavailable() {
            selectedHostels.forEach(hostelId => {
                const hostel = hostels.find(h => h.id === hostelId);
                if (hostel) {
                    hostel.available = false;
                }
            });
            
            saveHostels(); // Save to localStorage
            updateStats();
            renderHostels();
            clearBulkSelection();
            notifications.show(`${selectedHostels.size} hostels marked as unavailable`, 'warning');
        }
        
        function clearBulkSelection() {
            selectedHostels.clear();
            document.querySelectorAll('.hostel-checkbox').forEach(checkbox => {
                checkbox.checked = false;
            });
            document.getElementById('bulkActions').classList.remove('show');
        }
        
        function viewApplications(hostelId) {
            const hostel = hostels.find(h => h.id === hostelId);
            notifications.show(`Viewing ${hostel.applications} applications for ${hostel.name}`, 'info');
            Analytics.track('view_applications', { hostelId, hostelName: hostel.name });
        }
        
        function editHostel(hostelId) {
            const hostel = hostels.find(h => h.id === hostelId);
            if (!hostel) return;
            
            currentEditingHostelId = hostelId;
            
            // Populate the edit form
            document.getElementById('editHostelId').value = hostel.id;
            document.getElementById('editHostelName').value = hostel.name;
            document.getElementById('editHostelLocation').value = hostel.location;
            document.getElementById('editHostelPrice').value = hostel.price;
            document.getElementById('editHostelImage').value = hostel.image;
            document.getElementById('editHostelFeatures').value = hostel.features.join(', ');
            document.getElementById('editHostelWhatsApp').value = hostel.whatsapp || realtorProfile.whatsapp;
            document.getElementById('editHostelAvailable').checked = hostel.available;
            
            // Show the modal
            document.getElementById('editHostelModal').style.display = 'block';
            
            Analytics.track('edit_hostel_opened', { hostelId, hostelName: hostel.name });
        }
        
        // Add Hostel Modal Functions
        function showAddHostelModal() {
            document.getElementById('addHostelModal').style.display = 'block';
            document.getElementById('addHostelForm').reset();
        }
        
        function closeAddHostelModal() {
            document.getElementById('addHostelModal').style.display = 'none';
        }
        
        function handleAddHostel(event) {
            event.preventDefault();
            
            const name = document.getElementById('hostelName').value.trim();
            const location = document.getElementById('hostelLocation').value.trim();
            const description = document.getElementById('hostelDescription').value.trim();
            const price = parseInt(document.getElementById('hostelPrice').value);
            
            // Validation
            if (!location) {
                notifications.show('‚ùå Please select a gate area (location)', 'error');
                return false;
            }

            if (description.length < 50) {
                notifications.show('‚ùå Description must be at least 50 characters', 'error');
                return false;
            }
            
            // Get images from hidden input
            const imageUrls = document.getElementById('hostelImageUrls').value;
            const images = imageUrls ? imageUrls.split(',') : [];
            
            if (images.length === 0) {
                notifications.show('‚ùå Please upload at least 1 hostel image', 'error');
                return false;
            }

            const image = images[0];
            
            // Get video from hidden input
            const video = document.getElementById('hostelVideoUrl').value.trim() || null;
            
            const featuresInput = document.getElementById('hostelFeatures').value.trim();
            const features = featuresInput ? featuresInput.split(',').map(f => f.trim()) : ['WiFi', 'Security'];
            const available = document.getElementById('hostelAvailable').checked;
            const whatsapp = document.getElementById('hostelWhatsApp').value.trim() || realtorProfile.whatsapp;
            
            // Create new hostel object for API
            const newHostelData = {
                name,
                location,
                description,
                price,
                image,
                images: images,
                video,
                available,
                features,
                whatsapp,
                realtorId: REALTOR_ID,
                realtorName: realtorProfile.name,
                realtorEmail: realtorProfile.email
            };
// Show loading state
            const submitButton = event.target.querySelector('button[type="submit"]');
            const originalText = submitButton.textContent;
            submitButton.textContent = 'Creating...';
            submitButton.disabled = true;
            
            // Send to API
            HostelAPI.createHostel(newHostelData)
                .then(async (createdHostel) => {
// Reload hostels from API
                    await loadHostelsFromAPI();
                    
                    // Update UI
                    updateStats();
                    renderHostels();
                    
                    // Reset form and clear uploads
                    uploadedHostelImages = [];
                    uploadedHostelVideo = null;
                    updateHostelImagesPreview();
                    document.getElementById('hostelVideoPreview').style.display = 'none';
                    document.getElementById('hostelVideoStatus').textContent = 'Upload Video Tour';
                    
                    // Close modal
                    closeAddHostelModal();
                    
                    // Show success notification
                    notifications.show(`‚úÖ ${name} added successfully!`, 'success');
                    
                    Analytics.track('hostel_added', { hostelId: createdHostel._id, hostelName: name });
                })
                .catch((error) => {
                    console.error('‚ùå Error creating hostel:', error);
                    notifications.show(`‚ùå Error: ${error.message}`, 'error');
                })
                .finally(() => {
                    // Reset button
                    submitButton.textContent = originalText;
                    submitButton.disabled = false;
                });
            
            return false;
        }
        
        // Edit Hostel Modal Functions
        function closeEditHostelModal() {
            document.getElementById('editHostelModal').style.display = 'none';
            currentEditingHostelId = null;
        }
        
        function handleEditHostel(event) {
            event.preventDefault();
            
            const hostelId = currentEditingHostelId;
            const hostel = hostels.find(h => h._id === hostelId);
            
            if (!hostel) {
                notifications.show('‚ùå Hostel not found', 'error');
                return false;
            }
            
            // Get images from hidden input
            const imageUrls = document.getElementById('editHostelImageUrls').value;
            const images = imageUrls ? imageUrls.split(',') : (hostel.images || [hostel.image]);
            const image = images.length > 0 ? images[0] : hostel.image;
            
            // Get video from hidden input
            const video = document.getElementById('editHostelVideoUrl').value.trim() || hostel.video || null;
            
            // Prepare updated data
            const updatedData = {
                name: document.getElementById('editHostelName').value.trim(),
                location: document.getElementById('editHostelLocation').value.trim(),
                price: parseInt(document.getElementById('editHostelPrice').value),
                image,
                images: images.length > 0 ? images : [image], // Save all images
                video, // Add video URL
                features: document.getElementById('editHostelFeatures').value.trim() 
                    ? document.getElementById('editHostelFeatures').value.trim().split(',').map(f => f.trim())
                    : hostel.features,
                whatsapp: document.getElementById('editHostelWhatsApp').value.trim() || realtorProfile.whatsapp,
                available: document.getElementById('editHostelAvailable').checked,
                realtorId: REALTOR_ID,
                realtorName: realtorProfile.name,
                realtorEmail: realtorProfile.email
            };
// Show loading state
            const submitButton = event.target.querySelector('button[type="submit"]');
            const originalText = submitButton.textContent;
            submitButton.textContent = 'Updating...';
            submitButton.disabled = true;
            
            // Send to API
            HostelAPI.updateHostel(hostelId, updatedData)
                .then(async (updatedHostel) => {
// Reload hostels from API
                    await loadHostelsFromAPI();
                    
                    // Update UI
                    updateStats();
                    renderHostels();
                    
                    // Reset uploads
                    editUploadedHostelImages = [];
                    editUploadedHostelVideo = null;
                    
                    // Close modal
                    closeEditHostelModal();
                    
                    // Show success notification
                    notifications.show(`‚úÖ ${updatedHostel.name} updated successfully!`, 'success');
                    
                    Analytics.track('hostel_updated', { hostelId, hostelName: updatedHostel.name });
                })
                .catch((error) => {
                    console.error('‚ùå Error updating hostel:', error);
                    notifications.show(`‚ùå Error: ${error.message}`, 'error');
                })
                .finally(() => {
                    // Reset button
                    submitButton.textContent = originalText;
                    submitButton.disabled = false;
                });
            
            return false;
        }
        
        function deleteHostel() {
            const hostelId = currentEditingHostelId;
            const hostel = hostels.find(h => h._id === hostelId);
            
            if (!hostel) {
                notifications.show('‚ùå Hostel not found', 'error');
                return;
            }
            
            const confirmDelete = confirm(`Are you sure you want to delete "${hostel.name}"? This action cannot be undone.`);
            
            if (confirmDelete) {
                // Show loading notification
                notifications.show('üóëÔ∏è Deleting hostel...', 'info');
                
                // Send delete request to API
                HostelAPI.deleteHostel(hostelId)
                    .then(async () => {
// Reload hostels from API
                        await loadHostelsFromAPI();
                        
                        // Update UI
                        updateStats();
                        renderHostels();
                        
                        // Close modal
                        closeEditHostelModal();
                        
                        // Show success notification
                        notifications.show(`üóëÔ∏è ${hostel.name} deleted successfully`, 'success');
                        
                        Analytics.track('hostel_deleted', { hostelId, hostelName: hostel.name });
                    })
                    .catch((error) => {
                        console.error('‚ùå Error deleting hostel:', error);
                        notifications.show(`‚ùå Error: ${error.message}`, 'error');
                    });
            }
        }
        
        // Direct delete function for hostel list delete buttons
        function openDeleteModal(hostelId) {
            const hostel = hostels.find(h => h._id === hostelId);
            
            if (!hostel) {
                notifications.show('‚ùå Hostel not found', 'error');
                return;
            }
            
            const confirmDelete = confirm(`Are you sure you want to delete "${hostel.name}"?\n\nLocation: ${hostel.location}\nPrice: ${Utils.formatCurrency(hostel.price)}\n\nThis action cannot be undone.`);
            
            if (confirmDelete) {
                // Show loading notification
                notifications.show('üóëÔ∏è Deleting hostel...', 'info');
                
                // Send delete request to API
                HostelAPI.deleteHostel(hostelId)
                    .then(async () => {
// Reload hostels from API
                        await loadHostelsFromAPI();
                        
                        // Update UI
                        updateStats();
                        renderHostels();
                        
                        // Show success notification
                        notifications.show(`üóëÔ∏è ${hostel.name} deleted successfully`, 'success');
                        
                        // Track deletion
                        if (typeof Analytics !== 'undefined') {
                            Analytics.track('hostel_deleted', { hostelId, hostelName: hostel.name });
                        }
                    })
                    .catch((error) => {
                        console.error('‚ùå Error deleting hostel:', error);
                        notifications.show(`‚ùå Failed to delete: ${error.message}`, 'error');
                    });
            }
        }
        
        function editHostel(hostelId) {
            const hostel = hostels.find(h => h._id === hostelId);
            
            if (!hostel) {
                notifications.show('‚ùå Hostel not found', 'error');
                return;
            }
            
            currentEditingHostelId = hostelId;
            
            // Fill form with hostel data
            document.getElementById('editHostelId').value = hostel._id;
            document.getElementById('editHostelName').value = hostel.name;
            document.getElementById('editHostelLocation').value = hostel.location;
            document.getElementById('editHostelPrice').value = hostel.price;
            document.getElementById('editHostelImage').value = hostel.image;
            document.getElementById('editHostelFeatures').value = hostel.features.join(', ');
            document.getElementById('editHostelWhatsApp').value = hostel.whatsapp;
            document.getElementById('editHostelAvailable').checked = hostel.available;
            
            // Show modal
            document.getElementById('editHostelModal').style.display = 'block';
        }
        
        // Close modals when clicking outside
        window.addEventListener('click', function(event) {
            const addModal = document.getElementById('addHostelModal');
            const editModal = document.getElementById('editHostelModal');
            const profileModal = document.getElementById('profileModal');
            
            if (event.target === addModal) {
                closeAddHostelModal();
            }
            if (event.target === editModal) {
                closeEditHostelModal();
            }
            if (event.target === profileModal) {
                closeProfileModal();
            }
        });
        
        // Profile Management Functions
        function showProfileModal() {
            document.getElementById('profileName').value = realtorProfile.name;
            document.getElementById('profileWhatsApp').value = realtorProfile.whatsapp;
            document.getElementById('profileModal').style.display = 'block';
        }
        
        function closeProfileModal() {
            document.getElementById('profileModal').style.display = 'none';
        }
        
        function handleProfileUpdate(event) {
            event.preventDefault();
            
            const newName = document.getElementById('profileName').value.trim();
            const newWhatsApp = document.getElementById('profileWhatsApp').value.trim();
            
            // Validate WhatsApp number format
            if (!/^[0-9]{13}$/.test(newWhatsApp)) {
                notifications.show('‚ùå WhatsApp number must be 13 digits (e.g., 2348145653433)', 'error');
                return false;
            }
            
            // Update profile
            realtorProfile.name = newName;
            realtorProfile.whatsapp = newWhatsApp;
            
            // Save to localStorage
            localStorage.setItem('realtorProfile', JSON.stringify(realtorProfile));
            
            // Update UI
            document.getElementById('realtorName').textContent = newName;
            
            // Close modal
            closeProfileModal();
            
            // Show success notification
            notifications.show(`‚úÖ Profile updated successfully!`, 'success');
            
            Analytics.track('profile_updated', { name: newName });
            
            return false;
        }
        
        // Load profile name on page load
        function loadRealtorProfile() {
            if (realtorProfile && realtorProfile.name) {
                document.getElementById('realtorName').textContent = realtorProfile.name;
            }
        }
        
        function setupEventListeners() {
            // Search functionality
            const searchInput = document.getElementById('hostelSearch');
            searchInput.addEventListener('input', Utils.debounce(() => {
                renderHostels();
            }, 300));
            
            // Filter tabs
            document.querySelectorAll('.filter-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    // Update active tab
                    document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    // Update filter
                    currentFilter = tab.dataset.filter;
                    renderHostels();
                    
                    Analytics.track('filter_changed', { filter: currentFilter });
                });
            });
        }
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', initializeDashboard);
        
        // Cloudinary Upload Widget Configuration for Multiple Images
        let uploadedHostelImages = [];
        let editUploadedHostelImages = [];
        let uploadedHostelVideo = null;
        let editUploadedHostelVideo = null;
        
        function openHostelImagesWidget() {
            const widget = cloudinary.createUploadWidget({
                cloudName: 'dsu1po0tg',
                uploadPreset: 'mwg_hostels_unsigned',
                sources: ['local', 'camera', 'url'],
                multiple: true,
                maxFiles: 5 - uploadedHostelImages.length,
                maxFileSize: 5000000, // 5MB per image
                clientAllowedFormats: ['jpg', 'jpeg', 'png', 'gif', 'webp'],
                maxImageWidth: 1920,
                maxImageHeight: 1080,
                folder: 'mwg-hostels/hostels',
                resourceType: 'image',
                theme: 'minimal',
                styles: {
                    palette: {
                        window: '#FFFFFF',
                        windowBorder: '#10b981',
                        tabIcon: '#10b981',
                        menuIcons: '#5A616A',
                        textDark: '#000000',
                        textLight: '#FFFFFF',
                        link: '#10b981',
                        action: '#10b981',
                        inactiveTabIcon: '#9CA3AF',
                        error: '#dc2626',
                        inProgress: '#10b981',
                        complete: '#10b981',
                        sourceBg: '#F5F7FA'
                    }
                },
                text: {
                    'local.browse': 'Browse Files',
                    'local.dd_title_multi': 'Drag and Drop hostel images here (up to 5)'
                }
            }, (error, result) => {
                if (error) {
                    console.error('Upload error:', error);
                    alert('Upload failed: ' + error.message);
                    return;
                }
                
                if (result && result.event === 'success') {
                    const imageUrl = result.info.secure_url;
                    
                    if (uploadedHostelImages.length < 5) {
                        uploadedHostelImages.push(imageUrl);
                        updateHostelImagesPreview();
                        document.getElementById('hostelImageUrls').value = uploadedHostelImages.join(',');
                    }
                }
            });
            
            widget.open();
        }
        
        function updateHostelImagesPreview() {
            const preview = document.getElementById('hostelImagesPreview');
            const counter = document.getElementById('hostelImageCount');
            
            counter.textContent = uploadedHostelImages.length;
            preview.innerHTML = '';
            
            uploadedHostelImages.forEach((url, index) => {
                const imageContainer = document.createElement('div');
                imageContainer.style.position = 'relative';
                imageContainer.innerHTML = `
                    <img src="${url}" alt="Hostel ${index + 1}" style="width: 100%; height: 120px; object-fit: cover; border-radius: 8px; border: 2px solid #10b981;">
                    <button onclick="removeHostelImage('${url}')" style="position: absolute; top: 4px; right: 4px; background: #ef4444; color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-size: 14px; display: flex; align-items: center; justify-content: center;">√ó</button>
                    ${index === 0 ? '<div style="position: absolute; bottom: 4px; left: 4px; background: #10b981; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: 600;">Main</div>' : ''}
                `;
                preview.appendChild(imageContainer);
            });
        }
        
        function removeHostelImage(imageUrl) {
            uploadedHostelImages = uploadedHostelImages.filter(url => url !== imageUrl);
            updateHostelImagesPreview();
            document.getElementById('hostelImageUrls').value = uploadedHostelImages.join(',');
        }
        
        function openHostelVideoWidget() {
            const widget = cloudinary.createUploadWidget({
                cloudName: 'dsu1po0tg',
                uploadPreset: 'mwg_hostels_unsigned',
                sources: ['local', 'camera'],
                multiple: false,
                maxFileSize: 52428800, // 50MB
                clientAllowedFormats: ['mp4', 'mov', 'avi', 'webm', 'mkv'],
                folder: 'mwg-hostels/hostel-videos',
                resourceType: 'video',
                theme: 'minimal',
                styles: {
                    palette: {
                        window: '#FFFFFF',
                        windowBorder: '#8b5cf6',
                        tabIcon: '#8b5cf6',
                        menuIcons: '#5A616A',
                        textDark: '#000000',
                        textLight: '#FFFFFF',
                        link: '#8b5cf6',
                        action: '#8b5cf6',
                        inactiveTabIcon: '#9CA3AF',
                        error: '#dc2626',
                        inProgress: '#8b5cf6',
                        complete: '#8b5cf6',
                        sourceBg: '#F5F7FA'
                    }
                },
                text: {
                    'local.browse': 'Browse Video Files',
                    'local.dd_title_single': 'Drag and Drop hostel video tour here'
                }
            }, (error, result) => {
                if (error) {
                    console.error('Upload error:', error);
                    alert('Upload failed: ' + error.message);
                    return;
                }
                
                if (result && result.event === 'success') {
                    uploadedHostelVideo = result.info.secure_url;
                    document.getElementById('hostelVideoUrl').value = uploadedHostelVideo;
                    document.getElementById('hostelVideoStatus').textContent = '‚úÖ Video uploaded';
                    
                    // Show video preview
                    const preview = document.getElementById('hostelVideoPreview');
                    const video = document.getElementById('hostelPreviewVideo');
                    video.querySelector('source').src = uploadedHostelVideo;
                    video.load();
                    preview.style.display = 'block';
                }
            });
            
            widget.open();
        }
        
        function removeHostelVideo() {
            uploadedHostelVideo = null;
            document.getElementById('hostelVideoUrl').value = '';
            document.getElementById('hostelVideoStatus').textContent = 'Upload Video Tour';
            document.getElementById('hostelVideoPreview').style.display = 'none';
        }
        
        // Edit form versions
        function openEditHostelImagesWidget() {
            const widget = cloudinary.createUploadWidget({
                cloudName: 'dsu1po0tg',
                uploadPreset: 'mwg_hostels_unsigned',
                sources: ['local', 'camera', 'url'],
                multiple: true,
                maxFiles: 5 - editUploadedHostelImages.length,
                maxFileSize: 5000000,
                clientAllowedFormats: ['jpg', 'jpeg', 'png', 'gif', 'webp'],
                maxImageWidth: 1920,
                maxImageHeight: 1080,
                folder: 'mwg-hostels/hostels',
                resourceType: 'image',
                theme: 'minimal',
                styles: {
                    palette: {
                        window: '#FFFFFF',
                        windowBorder: '#10b981',
                        tabIcon: '#10b981',
                        menuIcons: '#5A616A',
                        textDark: '#000000',
                        textLight: '#FFFFFF',
                        link: '#10b981',
                        action: '#10b981',
                        inactiveTabIcon: '#9CA3AF',
                        error: '#dc2626',
                        inProgress: '#10b981',
                        complete: '#10b981',
                        sourceBg: '#F5F7FA'
                    }
                }
            }, (error, result) => {
                if (error) {
                    console.error('Upload error:', error);
                    alert('Upload failed: ' + error.message);
                    return;
                }
                
                if (result && result.event === 'success') {
                    const imageUrl = result.info.secure_url;
                    
                    if (editUploadedHostelImages.length < 5) {
                        editUploadedHostelImages.push(imageUrl);
                        updateEditHostelImagesPreview();
                        document.getElementById('editHostelImageUrls').value = editUploadedHostelImages.join(',');
                    }
                }
            });
            
            widget.open();
        }
        
        function updateEditHostelImagesPreview() {
            const preview = document.getElementById('editHostelImagesPreview');
            const counter = document.getElementById('editHostelImageCount');
            
            counter.textContent = editUploadedHostelImages.length;
            preview.innerHTML = '';
            
            editUploadedHostelImages.forEach((url, index) => {
                const imageContainer = document.createElement('div');
                imageContainer.style.position = 'relative';
                imageContainer.innerHTML = `
                    <img src="${url}" alt="Hostel ${index + 1}" style="width: 100%; height: 120px; object-fit: cover; border-radius: 8px; border: 2px solid #10b981;">
                    <button onclick="removeEditHostelImage('${url}')" style="position: absolute; top: 4px; right: 4px; background: #ef4444; color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-size: 14px; display: flex; align-items: center; justify-content: center;">√ó</button>
                    ${index === 0 ? '<div style="position: absolute; bottom: 4px; left: 4px; background: #10b981; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: 600;">Main</div>' : ''}
                `;
                preview.appendChild(imageContainer);
            });
        }
        
        function removeEditHostelImage(imageUrl) {
            editUploadedHostelImages = editUploadedHostelImages.filter(url => url !== imageUrl);
            updateEditHostelImagesPreview();
            document.getElementById('editHostelImageUrls').value = editUploadedHostelImages.join(',');
        }
        
        function openEditHostelVideoWidget() {
            const widget = cloudinary.createUploadWidget({
                cloudName: 'dsu1po0tg',
                uploadPreset: 'mwg_hostels_unsigned',
                sources: ['local', 'camera'],
                multiple: false,
                maxFileSize: 52428800,
                clientAllowedFormats: ['mp4', 'mov', 'avi', 'webm', 'mkv'],
                folder: 'mwg-hostels/hostel-videos',
                resourceType: 'video',
                theme: 'minimal',
                styles: {
                    palette: {
                        window: '#FFFFFF',
                        windowBorder: '#8b5cf6',
                        tabIcon: '#8b5cf6',
                        menuIcons: '#5A616A',
                        textDark: '#000000',
                        textLight: '#FFFFFF',
                        link: '#8b5cf6',
                        action: '#8b5cf6',
                        inactiveTabIcon: '#9CA3AF',
                        error: '#dc2626',
                        inProgress: '#8b5cf6',
                        complete: '#8b5cf6',
                        sourceBg: '#F5F7FA'
                    }
                }
            }, (error, result) => {
                if (error) {
                    console.error('Upload error:', error);
                    alert('Upload failed: ' + error.message);
                    return;
                }
                
                if (result && result.event === 'success') {
                    editUploadedHostelVideo = result.info.secure_url;
                    document.getElementById('editHostelVideoUrl').value = editUploadedHostelVideo;
                    document.getElementById('editHostelVideoStatus').textContent = '‚úÖ Video uploaded';
                    
                    const preview = document.getElementById('editHostelVideoPreview');
                    const video = document.getElementById('editHostelPreviewVideo');
                    video.querySelector('source').src = editUploadedHostelVideo;
                    video.load();
                    preview.style.display = 'block';
                }
            });
            
            widget.open();
        }
        
        function removeEditHostelVideo() {
            editUploadedHostelVideo = null;
            document.getElementById('editHostelVideoUrl').value = '';
            document.getElementById('editHostelVideoStatus').textContent = 'Upload Video Tour';
            document.getElementById('editHostelVideoPreview').style.display = 'none';
        }
    </script>
    
    <!-- Theme toggle.js removed - file doesn't exist (404 error) -->

    <script>
        window.addEventListener('error', function(e) {
            if (e.target.tagName === 'IMG') {
                e.target.src = e.target.src.includes('default') ? '' : 'assets/default-hostel.jpg';
            }
        }, true);
        
        window.addEventListener('unhandledrejection', function(e) {
            console.error('Promise rejection:', e.reason);
        });
    </script>
    
    <!-- Fixed Password System removed - security risk (exposes password in console) -->
    <!-- Dashboard initialization is handled by initializeDashboard() called on DOMContentLoaded -->
    
</body>
</html>
